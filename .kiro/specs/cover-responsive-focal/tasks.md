# 実装計画

- [x] 1. プロジェクト構造とコア型定義の設定

  - プラグインディレクトリ構造を作成（src/, build/, tests/）
  - TypeScript 型定義ファイル（types.ts）を作成
  - 定数定義ファイル（constants.ts）を作成
  - _要件: 1.1, 2.1_

- [x] 2. バリデーション関数の実装（TDD）

  - [x] 2.1 フォーカルポイント検証関数を TDD で実装

    - validateFocalPoint 関数のテストを先に作成
    - テストを通す最小限の実装を作成
    - _要件: 1.2, 3.1_

  - [x] 2.2 デバイスタイプ検証関数を TDD で実装（シンプル化）

    - validateDeviceType 関数のテストを先に作成
    - テストを通す実装を作成（mobile/tablet のみ）
    - _要件: 1.2, 1.3_

  - [x] 2.3 ResponsiveFocalPoint 作成関数を TDD で実装（シンプル化）
    - createResponsiveFocalPoint 関数のテストを先に作成（device, x, y のみ）
    - getMediaQueryForDevice 関数のテストを先に作成
    - テストを通す実装を作成
    - _要件: 1.4, 1.5_

- [ ] 2.4 CSS生成ユーティリティ関数の追加実装（新方針対応）

  - generateResponsiveFocalCSS 関数の実装（エディター用、PHP側crf_generate_css_rulesと整合性保持）
  - generateFocalPointSelector 関数の実装
  - sanitizeResponsiveFocalPoints 関数の実装
  - ブレークポイント定数を共有モジュール（constants.ts）に統一
  - PHP実装との依存関係整理（JSを参照実装としてPHPへポート）
  - _要件: 7.1_

- [x] 3. ブロック拡張システムの実装

  - [x] 3.1 カバーブロック属性拡張の実装

    - blocks.registerBlockType フィルターを実装
    - responsiveFocal 属性と dataFpId 属性を追加
    - 既存カバーブロック属性との統合テストを作成
    - _要件: 1.1, 2.1_

  - [x] 3.2 ブロック保存機能の拡張
    - save 関数の拡張を実装
    - data-fp-id 属性をマークアップに追加
    - 空の responsiveFocal 配列の場合の標準動作を維持
    - _要件: 2.3, 3.2_

- [x] 4. インスペクターコントロール UI の実装

  - [x] 4.1 基本 UI コンポーネントの作成（シンプル化）

    - ResponsiveFocalControls コンポーネントを作成
    - PanelBody の基本構造を実装
    - 固定2デバイス用の基本レイアウトを実装
    - _要件: 1.1, 6.1_

  - [x] 4.2 フォーカルポイント設定 UI の実装（シンプル化）

    - ToggleControl（モバイル用有効/無効）を実装
    - FocalPointPicker（モバイル用）コンポーネントを統合
    - ToggleControl（タブレット用有効/無効）を実装
    - FocalPointPicker（タブレット用）コンポーネントを統合
    - _要件: 6.1, 6.2, 6.3_

  - [x] 4.3 デバイス別状態管理の実装（シンプル化）
    - モバイル・タブレット用の固定2アイテム状態管理を実装
    - 各デバイス用のトグル状態管理を実装
    - _要件: 1.2, 1.3, 6.3_

- [x] 5. サーバーサイド CSS 生成の実装（TDD）

  - [x] 5.1 CSS 生成関数を TDD で実装（シンプル化）

    - crf_generate_css_rules 関数のテストを先に作成
    - モバイル用固定メディアクエリの CSS 生成を実装
    - タブレット用固定メディアクエリの CSS 生成を実装
    - _要件: 2.1, 2.2, 3.1_

  - [x] 5.2 サニタイゼーション関数を TDD で実装（シンプル化）

    - crf_sanitize_focal_point 関数のテストを先に作成
    - デバイスタイプの検証とサニタイゼーションを実装
    - XSS 攻撃防止の処理を実装
    - _要件: 3.1, 3.4_

  - [x] 5.3 render_block フィルターの実装
    - crf_render_block 関数を実装
    - data-fp-id 属性をコンテンツに追加する処理を実装
    - インラインスタイルタグの生成と挿入を実装
    - _要件: 2.3, 3.2_

- [x] 6. プラグインメインファイルの実装

  - [x] 6.1 PHP プラグインファイルの作成

    - cover-responsive-focal.php ファイルを作成
    - プラグインヘッダー情報を記述
    - 必要なフィルターフックを登録
    - _要件: 2.1, 2.3_

  - [x] 6.2 アセット読み込み処理の実装
    - wp_enqueue_script で JavaScript ファイルを読み込み
    - wp_enqueue_style で CSS ファイルを読み込み
    - 依存関係（wp-blocks, wp-element 等）を設定
    - _要件: 2.1, 2.4_

- [x] 7. ビルドシステムの設定

  - [x] 7.1 webpack 設定の作成

    - TypeScript 用の webpack.config.js を作成（@wordpress/scripts使用）
    - エントリーポイント（src/index.tsx）を設定
    - 出力先（build/）を設定
    - _要件: 2.1_

  - [x] 7.2 package.json 設定
    - 必要な依存関係を追加（@wordpress/blocks 等）
    - ビルドスクリプトを設定
    - 開発用スクリプトを設定
    - _要件: 2.1_

- [ ] 8. テスト環境の基盤設定（新方針準拠）

  - [x] 8.1 JavaScript/TypeScript テスト環境設定

    - Jest 設定ファイルを作成（WordPress独立コンポーネント用）
    - テストユーティリティとモックの設定
    - カバレッジレポート設定（テストピラミッド構造：単体テスト50%の比率、全体コードカバレッジ80%以上の閾値）
    - _要件: 7.1, 7.5_

  - [ ] 8.2 PHP テスト環境設定
    - PHPUnit 設定ファイルを作成（WordPress独立ロジック用）
    - WordPress Test Suite 環境設定（統合テスト用）
    - テストデータベース設定
    - 新方針に合わせたテストスイート構成の調整
    - WordPress Test Suite のダウンロード・インストール・ブートストラップ手順を明記
    - tests/phpunit/includes/bootstrap.php の配置
    - _要件: 7.1, 7.2_

- [ ] 9. E2E テスト環境の設定（クリティカルパス重視）

  - [x] 9.1 Playwright 環境設定

    - Playwright 設定ファイルを作成（クリティカルパス用）
    - WordPress 環境のセットアップ
    - テスト用データの準備
    - _要件: 7.3_

  - [ ] 9.2 E2E テストの実装（20%に絞り込み）
    - 現在のE2Eテストをクリティカルパスのみに絞り込み（新方針対応）
    - クリティカルパス定義：ブロック追加→画像設定→フォーカルポイント設定→保存→閲覧の基本フロー
    - 実行時間5分以内の制約に合わせてテストを最適化（npx playwright show-reportでタイムライン確認）
    - 非クリティカルなE2Eテストを統合テストまたは単体テストに移行
    - ビジュアル回帰テストを最小限に調整
    - _要件: 7.3, 7.4_

- [ ] 10. パフォーマンス最適化

  - [x] 10.1 CSS 生成の最適化

    - CSS 出力の最小化処理を実装 ✅
    - 重複メディアクエリの統合処理を実装 ✅
    - キャッシュ機能の実装 ✅
    - CSS最適化機能の専用テスト追加 ✅
    - _要件: 4.3, 4.4_

  - [ ] 10.2 フロントエンドパフォーマンス最適化
    - レイアウトシフト最小化の実装
    - 遅延読み込み対応の実装
    - _要件: 4.3, 4.4_

- [ ] 11. 国際化対応の実装

  - [ ] 11.1 翻訳ファイルの作成

    - POT ファイル生成設定を作成
    - 日本語翻訳ファイル（ja.po）を作成
    - 英語翻訳ファイル（en_US.po）を作成
    - _要件: 5.1_

  - [ ] 11.2 翻訳関数の実装
    - \_\_()関数を使用した文字列の翻訳対応
    - JavaScript 側の翻訳対応（wp.i18n）
    - _要件: 5.1_

- [ ] 12. CI/CD 環境の設定

  - [ ] 12.1 GitHub Actions 設定

    - 自動テスト実行ワークフローを作成
    - 複数 PHP/WordPress バージョンでのテストマトリックスを設定
    - コードカバレッジレポート生成を設定
    - _要件: 5.3_

  - [ ] 12.2 品質チェック設定
    - ESLint 設定を作成
    - PHP_CodeSniffer 設定を作成
    - 自動コード整形設定を作成
    - _要件: 5.1, 5.2_

- [ ] 13. ドキュメントとリリース準備

  - [x] 13.1 README.md ファイルの作成

    - インストール手順を記述 ✅
    - 使用方法を記述 ✅
    - 開発者向け情報を記述 ✅
    - _要件: 5.1_

  - [x] 13.2 WordPress.org 用 readme.txt の作成
    - プラグイン説明を記述 ✅
    - インストール手順を記述 ✅
    - FAQ・サポート情報を記述 ✅
    - _要件: 5.1_

- [ ] 14. 既存テストの新方針への調整

  - [ ] 14.1 既存テストファイルの分類と調整

    - 現在のE2Eテストをクリティカルパスと非クリティカルパスに分類
    - クリティカル判定基準：UIブロック崩れ→クリティカル、ラベル文言→非クリティカル
    - 複雑なE2Eテストを統合テストまたは単体テストに移行可能か検討
    - テストピラミッド構造（50%単体、30%統合、20%E2E）に合わせて調整
    - 完了条件：E2E spec数 ≤ 全specの20%
    - _要件: 7.1, 7.2, 7.3_

  - [ ] 14.2 テスト実行時間の最適化

    - E2Eテストの実行時間を測定し、5分以内の目標に調整
    - 並列実行可能なテストの特定と設定（GitHub Actions側でnpx playwright test --workers=nを設定）
    - 不要なテストの削除または統合
    - 完了条件：Playwright実行時間 ≤ 300秒
    - _要件: 7.4_

- [ ] 15. 最終統合テストと動作確認

  - [ ] 15.1 新テスト方針での全機能確認

    - テストピラミッド構造での全機能カバレッジ確認
    - クリティカルパスE2Eテストでの主要機能動作確認
    - 既存カバーブロックとの互換性を最終確認
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4, 5.5, 6.1, 6.2, 6.3, 6.4, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6_

  - [ ] 15.2 リリース前最終チェック
    - 新テスト戦略での全テストスイート実行と結果確認
    - パフォーマンス指標の最終確認（CLS < 0.1、LCP < 2.5s）
    - セキュリティチェックの最終確認
    - アクセシビリティ要件の最終確認（WCAG 2.1 AA基準、キーボード操作、ARIAラベル）
    - _要件: 3.3, 3.4, 4.3, 4.4, 7.5, 7.6_
